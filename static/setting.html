<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>シフト設定</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  <style>
    .card {
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .card-header {
      background-color: #007bff;
      color: #fff;
      border-bottom: none;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }
    .table th, .table td {
      vertical-align: middle;
    }
    /* ドラッグ中の行の見た目（任意） */
    .dragging {
      opacity: 0.5;
    }
    /* black_bar の行のスタイル - より強力な設定 */
  #employeesTable tr.divider-row,
  #employeesTable tr[style*="background-color: #000000"] {
    height: 0.1px !important;
    max-height: 0.1px !important;
    min-height: 0.1px !important;
    padding: 0 !important;
    margin: 0 !important;
    line-height: 0 !important;
    background-color: #000 !important;
    border: none !important;
    overflow: hidden !important;
  }
  
  /* テーブルスタイルの調整 */
  #employeesTable {
    border-collapse: collapse !important;
  }
  
  /* 区分線内のセルの高さを確実に制限 */
  #employeesTable tr[style*="background-color: #000000"] td {
    height: 0.1px !important;
    max-height: 0.1px !important;
    min-height:1px !important;
    padding: 0 !important;
    line-height: 0 !important;
    box-sizing: border-box !important;
    overflow: hidden !important;
  }

    
    #employeesTable tr.divider-row td {
      padding: 0 !important;
      border: none !important;
    }
    
    /* 削除ボタンセルのスタイル */
    #employeesTable tr.divider-row td:last-child {
      background-color: white !important;
      vertical-align: middle;
      text-align: center;
    }

  /* 既存のCSSに追加 */
  .thin-divider {
    height: 1px !important;
    background-color: #000 !important;
    padding: 0 !important;
    border: none !important;
    overflow: hidden !important;
    position: relative !important;
  }
  
  .thin-divider td {
    padding: 0 !important;
    border: none !important;
  }
  
  /* 削除ボタンを行の上に浮かせる */
  .thin-divider td.delete-cell {
    background-color: transparent !important;
    position: relative !important;
    height: 1px !important;
  }
  
  .thin-divider td.delete-cell button {
    position: absolute !important;
    top: -10px !important;
    right: 5px !important;
    z-index: 100 !important;
    font-size: 0.7rem !important;
    padding: 0px 4px !important;
  }

  </style>
</head>
<body>
  <!-- ナビゲーションバー -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="#">シフト管理システム</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">ホーム</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="setting.html">設定 <span class="sr-only">(current)</span></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="job_type.html">職種一覧</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    <h1 class="mb-4">従業員設定</h1>

    <!-- 従業員追加フォーム -->
    <div class="card mb-4">
      <div class="card-header">
        <h4 class="mb-0">従業員追加</h4>
      </div>
      <div class="card-body">
        <form id="addEmployeeForm">
          <div class="form-group">
            <label for="employeeName">名前 <span style="color:red;">*</span></label>
            <input type="text" class="form-control" id="employeeName" placeholder="名前を入力" required>
          </div>
          <div class="form-group">
            <label for="employeeMemo">メモ</label>
            <textarea class="form-control" id="employeeMemo" rows="2" placeholder="任意でメモを入力"></textarea>
          </div>
          <div class="d-flex">
            <button type="submit" class="btn btn-primary mr-2">追加</button>
            <button type="button" id="addDividerBtn" class="btn btn-outline-secondary">
              <i class="fas fa-minus"></i> 区分線追加
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 従業員一覧 -->
    <div class="card">
      <div class="card-header">
        <h4 class="mb-0">従業員一覧</h4>
      </div>
      <div class="card-body p-0">
        <table id="employeesTable" class="table table-hover mb-0">
          <thead>
            <tr>
              <th>名前</th>
              <th>メモ</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <!-- JavaScriptで従業員データを表示 -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- jQueryとBootstrapのJS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Sortable.js の読み込み -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

  <!-- setting.jsのコードをインラインで配置 -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
       // 従業員一覧の取得
    function loadEmployees() {
      fetch('/api/employees')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          const tbody = document.querySelector('#employeesTable tbody');
          tbody.innerHTML = ""; // 一旦クリア
          data.forEach(employee => {
            const tr = document.createElement('tr');
            // data属性に従業員IDを設定（並び順保存や memo 更新に利用）
            tr.setAttribute('data-id', employee.id);
            
            // 区分線の場合は特別な表示（nameがblack_barの場合）
            if (employee.name === "black_bar") {
  // 別のアプローチ：単純な1pxの黒線として表示
  tr.setAttribute('class', 'thin-divider');
  tr.setAttribute('style', 'height: 1px !important; background-color: #000000 !important;');
  
  // 名前とメモのセルを作成（幅を維持するため）
  const tdName = document.createElement('td');
  tdName.setAttribute('style', 'padding: 0 !important; border: none !important; background-color: #000000 !important;');
  tr.appendChild(tdName);
  
  const tdMemo = document.createElement('td');
  tdMemo.setAttribute('style', 'padding: 0 !important; border: none !important; background-color: #000000 !important;');
  tr.appendChild(tdMemo);
  
  // 削除ボタンセル（絶対配置）- 修正版
const tdActions = document.createElement('td');
tdActions.className = 'delete-cell';
tdActions.setAttribute('style', 'background-color: transparent !important; text-align: center; padding: 2px 4px !important; border: none !important; position: relative !important; overflow: visible !important; z-index: 5 !important;');

const deleteButton = document.createElement('button');
deleteButton.innerHTML = '<i class="fas fa-times"></i>';
deleteButton.className = 'btn btn-sm btn-outline-danger';
// より強力なスタイル設定
deleteButton.setAttribute('style', 'position: absolute !important; top: -14px !important; right: 5px !important; z-index: 10 !important; padding: 0px 4px !important; font-size: 0.7rem !important; background-color: white !important; box-shadow: 0 0 3px rgba(0,0,0,0.2) !important; border-radius: 3px !important;');
  
  // 削除ボタンのイベントリスナー
  deleteButton.addEventListener('click', function() {
    if (confirm("この区分線を削除してもよろしいですか？")) {
      fetch('/api/deleteEmployee', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: employee.id })
      })
      .then(response => response.ok ? response.json() : Promise.reject('削除に失敗しました'))
      .then(() => tr.remove())
      .catch(error => alert("削除エラー: " + error));
    }
  });
  
  tdActions.appendChild(deleteButton);
  tr.appendChild(tdActions);
} else {
              // 通常の従業員
              // 名前セル
              const tdName = document.createElement('td');
              tdName.textContent = employee.name;
              tr.appendChild(tdName);
        
              // メモセル（クリックで直接編集）
              const tdMemo = document.createElement('td');
              tdMemo.textContent = employee.memo || '';
              tdMemo.style.cursor = 'pointer';
              tdMemo.addEventListener('click', function() {
                if (tdMemo.querySelector('input')) return;
                const currentMemo = tdMemo.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control';
                input.value = currentMemo;
                tdMemo.innerHTML = "";
                tdMemo.appendChild(input);
                input.focus();
        
                input.addEventListener('keydown', function(e) {
                  if (e.key === "Enter") {
                    input.blur();
                  }
                });
        
                input.addEventListener('blur', function() {
                  const newMemo = input.value;
                  if (newMemo !== currentMemo) {
                    fetch('/api/saveMemo', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ id: employee.id, memo: newMemo })
                    })
                    .then(response => {
                      if (!response.ok) {
                        return response.text().then(text => { throw new Error(text) });
                      }
                      return response.json();
                    })
                    .then(result => {
                      console.log('メモ更新成功:', result);
                      tdMemo.textContent = newMemo;
                    })
                    .catch(error => {
                      console.error('メモ更新エラー:', error);
                      alert("メモの更新に失敗しました: " + error.message);
                      tdMemo.textContent = currentMemo;
                    });
                  } else {
                    tdMemo.textContent = currentMemo;
                  }
                }, { once: true });
              });
              tr.appendChild(tdMemo);
        
              // 操作セル（削除ボタンを追加）
              const tdActions = document.createElement('td');
              const deleteButton = document.createElement('button');
              deleteButton.textContent = '削除';
              deleteButton.classList.add('btn', 'btn-danger', 'btn-sm');
              deleteButton.addEventListener('click', function() {
                if (confirm("この従業員を削除してもよろしいですか？")) {
                  fetch('/api/deleteEmployee', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: employee.id })
                  })
                  .then(response => {
                    if (!response.ok) {
                      return response.text().then(text => { throw new Error(text) });
                    }
                    return response.json();
                  })
                  .then(result => {
                    console.log('削除成功:', result);
                    // DOMから該当の行を削除
                    tr.remove();
                  })
                  .catch(error => {
                    console.error('削除エラー:', error);
                    alert("削除に失敗しました: " + error.message);
                  });
                }
              });
              tdActions.appendChild(deleteButton);
              tr.appendChild(tdActions);
            }
        
            tbody.appendChild(tr);
          });
        })
        .catch(error => {
          console.error('従業員データの取得に失敗しました:', error);
          const tbody = document.querySelector('#employeesTable tbody');
          const errorRow = document.createElement('tr');
          const errorCell = document.createElement('td');
          errorCell.colSpan = 3;
          errorCell.textContent = 'データの読み込みに失敗しました。';
          errorCell.style.color = 'red';
          errorRow.appendChild(errorCell);
          tbody.appendChild(errorRow);
        });
    }
        
    loadEmployees();

    // 区分線追加ボタンのイベントリスナー
    const addDividerBtn = document.getElementById('addDividerBtn');
    if (addDividerBtn) {
        addDividerBtn.addEventListener('click', function() {
            // クリック時にコンソールにログ出力（デバッグ用）
            console.log('区分線追加ボタンがクリックされました');
            
            // AddEmployeeHandler にリクエストを送信
            fetch('/api/addEmployee', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    name: "black_bar", 
                    memo: "区分線" 
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text) });
                }
                return response.json();
            })
            .then(data => {
                console.log('区分線追加成功:', data);
                // 成功したら従業員一覧を再読み込み
                loadEmployees();
            })
            .catch(error => {
                console.error('区分線追加エラー:', error);
                alert('区分線の追加に失敗しました: ' + error.message);
            });
        });
    }

    
    // 従業員追加フォームの処理（既存の実装と同様）
    const addEmployeeForm = document.getElementById('addEmployeeForm');
    addEmployeeForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const nameInput = document.getElementById('employeeName');
      const memoInput = document.getElementById('employeeMemo');
    
      const name = nameInput.value.trim();
      const memo = memoInput.value.trim();
    
      if (name === "") {
        alert("名前は必須です。");
        return;
      }
    
      fetch('/api/addEmployee', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name, memo: memo })
      })
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => { throw new Error(text) });
        }
        return response.json();
      })
      .then(newEmployee => {
        const tbody = document.querySelector('#employeesTable tbody');
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', newEmployee.id);
    
        const tdName = document.createElement('td');
        tdName.textContent = newEmployee.name;
        tr.appendChild(tdName);
    
        const tdMemo = document.createElement('td');
        tdMemo.textContent = newEmployee.memo || '';
        tdMemo.style.cursor = 'pointer';
        tdMemo.addEventListener('click', function() {
          if (tdMemo.querySelector('input')) return;
          const currentMemo = tdMemo.textContent;
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          input.value = currentMemo;
          tdMemo.innerHTML = "";
          tdMemo.appendChild(input);
          input.focus();
    
          input.addEventListener('keydown', function(e) {
            if (e.key === "Enter") {
              input.blur();
            }
          });
    
          input.addEventListener('blur', function() {
            const newMemo = input.value;
            if (newMemo !== currentMemo) {
              fetch('/api/saveMemo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: newEmployee.id, memo: newMemo })
              })
              .then(response => {
                if (!response.ok) {
                  return response.text().then(text => { throw new Error(text) });
                }
                return response.json();
              })
              .then(result => {
                console.log('メモ更新成功:', result);
                tdMemo.textContent = newMemo;
              })
              .catch(error => {
                console.error('メモ更新エラー:', error);
                alert("メモの更新に失敗しました: " + error.message);
                tdMemo.textContent = currentMemo;
              });
            } else {
              tdMemo.textContent = currentMemo;
            }
          }, { once: true });
        });
        tr.appendChild(tdMemo);
    
        const tdActions = document.createElement('td');
        const deleteButton = document.createElement('button');
        deleteButton.textContent = '削除';
        deleteButton.classList.add('btn', 'btn-danger', 'btn-sm');
        deleteButton.addEventListener('click', function() {
          if (confirm("この従業員を削除してもよろしいですか？")) {
            fetch('/api/deleteEmployee', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: newEmployee.id })
            })
            .then(response => {
              if (!response.ok) {
                return response.text().then(text => { throw new Error(text) });
              }
              return response.json();
            })
            .then(result => {
              console.log('削除成功:', result);
              tr.remove();
            })
            .catch(error => {
              console.error('削除エラー:', error);
              alert("削除に失敗しました: " + error.message);
            });
          }
        });
        tdActions.appendChild(deleteButton);
        tr.appendChild(tdActions);
    
        if (tbody.firstChild) {
          tbody.insertBefore(tr, tbody.firstChild);
        } else {
          tbody.appendChild(tr);
        }
    
        nameInput.value = "";
        memoInput.value = "";
      })
      .catch(error => {
        console.error('従業員の追加に失敗しました:', error);
        alert("従業員の追加に失敗しました: " + error.message);
      });
    });
    
    // ドラッグ＆ドロップ処理（従来通り）
    var tbody = document.querySelector('#employeesTable tbody');
    new Sortable(tbody, {
      animation: 150,
      onStart: function (evt) {
        evt.item.classList.add('dragging');
      },
      onEnd: function (evt) {
        evt.item.classList.remove('dragging');
        console.log('行が移動されました: ', evt.oldIndex, '→', evt.newIndex);
        
        const rows = document.querySelectorAll('#employeesTable tbody tr');
        const newOrder = Array.from(rows).map(row => Number(row.getAttribute('data-id')));
        
        fetch('/api/updateEmployeeOrder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order: newOrder })
        })
        .then(response => {
          if (!response.ok) {
            return response.text().then(text => { throw new Error(text) });
          }
          return response.json();
        })
        .then(result => {
          console.log('並び順更新成功:', result);
        })
        .catch(error => {
          console.error('並び順更新エラー:', error);
          alert("並び順の更新に失敗しました: " + error.message);
        });
      }
    });
  });
  </script>
</body>
</html>